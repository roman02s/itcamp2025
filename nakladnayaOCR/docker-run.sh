#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Docker —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CUDA

echo "üê≥ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —á–µ—Ä–µ–∑ Docker (CUDA)"
echo "======================================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
    exit 1
fi

if ! command -v docker compose &> /dev/null && ! docker compose version &> /dev/null 2>&1; then
    echo "‚ùå Docker Compose –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ NVIDIA Docker runtime
if ! nvidia-smi &> /dev/null; then
    echo "‚ö†Ô∏è  NVIDIA GPU –∏–ª–∏ NVIDIA Container Runtime –Ω–µ –Ω–∞–π–¥–µ–Ω."
    echo "   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ GPU."
    echo "   –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è CUDA —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ NVIDIA Docker runtime."
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ GPU? (y/n): " continue_without_gpu
    if [ "$continue_without_gpu" != "y" ]; then
        exit 1
    fi
else
    echo "‚úÖ NVIDIA GPU –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞"
    nvidia-smi
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p uploads temp data

# –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∑–∞–ø—É—Å–∫–∞
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞:"
echo "1) –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º (production)"
echo "2) –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (development)"
echo "3) –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
echo "4) –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã"
echo "5) –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-5): " choice

case $choice in
    1)
        echo "üöÄ –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ..."
        docker compose up -d
        ;;
    2)
        echo "üõ†Ô∏è  –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
        if [ -f "docker-compose.dev.yml" ]; then
            docker compose -f docker-compose.dev.yml up -d
        else
            echo "‚ùå –§–∞–π–ª docker-compose.dev.yml –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å–∫ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ..."
            docker compose up -d
        fi
        ;;
    3)
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        docker compose down
        if [ -f "docker-compose.dev.yml" ]; then
            docker compose -f docker-compose.dev.yml down
        fi
        ;;
    4)
        echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
        docker compose down
        docker compose build
        docker compose up -d
        ;;
    5)
        echo "üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤..."
        docker compose logs -f
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 1, 2, 3, 4 –∏–ª–∏ 5."
        exit 1
        ;;
esac

if [ "$choice" = "1" ] || [ "$choice" = "2" ]; then
    echo ""
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
    echo "üåê –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8501"
    echo "üìä –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤: docker compose logs -f"
    echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ./docker-run.sh (–≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é 3)"
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ GPU –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
    echo "   docker exec nakladnaya-ocr-app nvidia-smi"
fi
